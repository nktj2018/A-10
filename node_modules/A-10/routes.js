var querystring = require('querystring');

module.exports=new function(){

	this.check=function(req){

		var response={};

		var split_url=req.url.split("?");
		var urla=split_url[0];

		if(split_url[1]){
			var gets=split_url[1]
		}

		if(urla=="/"){
			var target_a=["/"];
		}
		else
		{
			var target_a=split_url[0].split("/");
			target_a.shift();
		}

		var aregments=[];

		var rt_length=rt_web.pages.length;
		for(var n1=0;n1<rt_length;n1++){
			var r_=rt_web.pages[n1];

			if(r_[0]=="/"){
				var target_b=["/"];
			}
			else
			{
				var target_b=r_[0].split("/");
				target_b.shift();
			}

			var juge=true;
			if(target_a.length>target_b.length){
				var length=target_a.length;
			}
			else
			{
				var length=target_b.length;
			}

			for(var u1=0;u1<length;u1++){

				if(!target_b[u1]){
					juge=false;
					break;
				}

				var test_target="."+target_b[u1]+".";

				var aregmented=false;
				var any=false;
				if(test_target.indexOf("{:")>0 && test_target.indexOf("}")>0){
					var aregKey=test_target.replace(".{:","");
					aregKey=aregKey.replace("}.","");
					aregmented=true;
				}
				if(test_target.indexOf("{:")>0 && test_target.indexOf("?}")>0){
					var aregKey=test_target.replace(".{:","");
					aregKey=aregKey.replace("?}.","");
					any=true;
				}

				if(aregmented){
					if(!any){
						if(!target_a[u1]){
							juge=false;
							break;
						}
					}

					if(target_a[u1]){
						aregments.push(target_a[u1]);
					}
					else
					{
						aregments.push(null);
					}
				}
				else
				{
					if(target_a[u1]!=target_b[u1]){
						juge=false;
						break;
					}
				}
			}

			if(juge){
				var confirm_routing=r_[1];
				break;
			}
		}

		return new Promise(function(resolve){

			if(confirm_routing){
				if(typeof(confirm_routing)=="string"){

					var split=confirm_routing.split("@");
					if(split[1]){
						response.route={
							controller:split[0],
							action:split[1],
						};
					}
					else
					{
						response.route={
							view:split[0]
						};
					}
				}
				else
				{
					response.route=confirm_routing;
				}
				response.route.aregment=aregments;

				response.request={
					urlFull:req.url,
					url:urla,
					method:req.method
				};

				if(gets){
					var getparam={};
					var getarray=gets.split("&");
					var getarrayLength=getarray.length;
					for(var u1=0;u1<getarrayLength;u1++){
						var sep=getarray[u1].split("=");
						if(sep[0]){
							if(!sep[1]){
								sep[1]=null;
							}
							getparam[sep[0]]=sep[1];
						}
					}

					response.GET=getparam;
				}

				if(req.method=="POST"){
					var data = '';
					req.setEncoding('utf8');
				    req.on('data', function(chunk) {
			    		data += chunk || "";
					});
		    		req.on('end', function() {
			    		querystring.parse(data);

						var postparam={};
						var das=data.split("&");
						var dasLength=das.length;
						for(n1=0;n1<dasLength;n1++){
							var sep=das[n1].split("=");
							if(sep[0]){
								if(!sep[1]){ sep[1]=null; }
								postparam[sep[0]]=sep[1];
							}
						}
						response.POST=postparam;
						resolve(response);
					});

					return;
				}
			}

			resolve(response);
		});
	};

};