// =======================================================================
// 
//
// index.js
//
//
// =======================================================================

const http=require('http');
global.fs=require("fs");

global.A10EJS=require("A10EJS");

global.func=require("./function.js");
global.errors=require("./error.js");
global.Objects=require("./Objects.js");
global.Controller=require("./Controller.js");
global.View=require("./View.js");

global.mime=require("../../app/Config/mime.js");
global.config=require("../../app/Config/config.js");
global.rt_web=require("../../app/Config/routing-web.js");

module.exports={

	listen:function(port){

		let bef=process.memoryUsage();

		console.log(func.getDate()+" Server Start (PORT="+port+")"); 

		var routes=require("./routes.js");
		var publics=require("./publics.js");

		var server = http.createServer(function(request, response){

			routes.check(request).then(function(routing){

				//console.log(routing);

				var err=null;
				var errView=false;
				var write_output="";

				if(routing.route){
					if(routing.route.controller){

						//controller file exists check;
						try{
							fs.statSync("./app/Controller/"+func.snake_case(routing.route.controller)+"_Controller.js");
						}catch(err){
							errors.out(response,"no_controller",{
								controller_name:func.snake_case(routing.route.controller),
							});
							return;
						}

						//controller class exists check;
						try{
							const Controller=require("../../app/Controller/"+func.snake_case(routing.route.controller)+"_Controller.js");
							var controller=new Controller(routing);
						}catch(err){
							errors.out(response,"no_exists_controller",{
								controller_name:func.snake_case(routing.route.controller),
							});
							return;
						}

						//action exists check;
						if(typeof(controller[routing.route.action])!="function"){
							errors.out(response,"no_exists_method",{
								controller_name:func.snake_case(routing.route.controller),
								action_name:routing.route.action,
							});
							return;
						}

						try{

							//setting..
							controller.setting();

							var pc=Promise.resolve();
							pc.then(function(){

								if(controller.logic_before){
									return new Promise(function(resolve){
										var cb_=controller.logic_before();

										if(cb_ instanceof Promise){

											cb_.then(function(rest){
												if(rest){
													write_output+=rest;
												}
												resolve();
											});

										}
										else
										{
											if(typeof(cb_)=="string"){
												write_output+=cb_;
											}
											resolve();
										}
									});
								}
							}).then(function(){
								if(controller[routing.route.action]){
									return new Promise(function(resolve){

										if(routing.route.aregment){
											var cc_=controller[routing.route.action](...routing.route.aregment);
										}
										else
										{
											var cc_=controller[routing.route.action]();
										}

										if(cc_ instanceof Promise){
											cc_.then(function(rest){
												if(rest){
													write_output+=rest;
												}
												resolve();
											});
										}
										else
										{
											if(typeof(cc_)=="string"){
												write_output+=cc_;
											}
											resolve();
										}
									});
								}
							}).then(function(){
								if(controller.logic_after){
									return new Promise(function(resolve){
										var ca_=controller.logic_after();

										if(ca_ instanceof Promise){
											ca_.then(function(rest){
												if(rest){
													write_output+=rest;
												}
												resolve();
											});
										}
										else
										{
											if(typeof(ca_)=="string"){
												write_output+=ca_;
											}
											resolve();
										}
									});
								}
							}).then(function(){

								//rendering
								controller.__renderingings(response,write_output);

								/*
								// memory log
								let af=process.memoryUsage();
								console.log({
									rss:af.rss-bef.rss,
									heapTotal:af.heapTotal-bef.heapTotal,
									heapUsed:af.heapUsed-bef.heapUsed,
									external:af.external-bef.external,
								});
								*/

							});

						}catch(err){
							console.log(err);
							errView=true;
						}

						if(errView){
					        response.writeHead(200, {'Content-Type': 'text/html'});
					        response.write('<!DOCTYPE html>');
					        response.write('<html lang="ja">');
					        response.write('NOT FOUND!');
					        response.write('</html>');
					        response.end();
						}
					}
					else if(routing.route.view){

						if(!config.content_type){
							config.content_type="text/html";
						}
						if(!config.charset){
							config.charset="utf-8";
						}

						var setHeader={
							'Content-Type': config.content_type,
							'charset':config.charset
						};

						response.writeHead(200, setHeader);
	
						var renderPath="./app/Render/View/"+routing.route.view+".view";

						var view=new View(response,renderPath,null,{
							mode:"view",
							elementPath:null
						});

						response.end();
					}
				}
				else if(publics.check(request.url)){
					publics.load(request.url,response);
				}
				else
				{
			        response.writeHead(404, {'Content-Type': 'text/html'});
			        response.end();
				}

			});
		
	    }).listen(port);
	}

};